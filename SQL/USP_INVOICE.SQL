USE [eplus_work]
GO
/****** Object:  StoredProcedure [dbo].[USP_INVOICE_AUTO_REST_2]    Script Date: 10.12.2019 2:59:21 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[USP_INVOICE_AUTO_REST_2]
	(@ID_STORE BIGINT,
     @ID_DOCUMENT UNIQUEIDENTIFIER,
	 @ID_STORE_TO BIGINT)
AS
SELECT  LOT.ID_LOT 'ID_PARTY', 
	LOT.ID_GOODS, 
	LOT.ID_SCALING_RATIO 'ID_SCALE_RATIO', 
	LOT.QUANTITY_REM 'STORE_QUANTITY',
    V_GOODS_NAMES.[NM] 'GOODS_NAME',
	DBO.FN_SCALE_NAME(LOT.ID_SCALING_RATIO) 'SCALE_RATIO_NAME' ,
	REMAIN = ISNULL (VRU.REMAIN,0), 
	 SOLD = ISNULL (SOLD,0)
FROM LOT
LEFT JOIN V_GOODS_NAMES ON LOT.ID_GOODS = V_GOODS_NAMES.ID_GOODS
LEFT JOIN (select nm, SUm (QTY) AS REMAIN, 
sum (prodano) AS SOLD from V_REMAINS_UNITED
where id_store = @ID_STORE_TO
group by V_REMAINS_UNITED.NM
) as VRU ON VRU.NM = V_GOODS_NAMES.NM
WHERE (LOT.ID_STORE = @ID_STORE or LOT.ID_DOCUMENT = @ID_DOCUMENT)
    AND LOT.QUANTITY_REM > 0 
order by NAME 
RETURN 0